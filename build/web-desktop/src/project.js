window.__require=function t(e,o,i){function n(r,h){if(!o[r]){if(!e[r]){var a=r.split("/");if(a=a[a.length-1],!e[a]){var u="function"==typeof __require&&__require;if(!h&&u)return u(a,!0);if(s)return s(a,!0);throw new Error("Cannot find module '"+r+"'")}}var l=o[r]={exports:{}};e[r][0].call(l.exports,function(t){return n(e[r][1][t]||t)},l,l.exports,t,e,o,i)}return o[r].exports}for(var s="function"==typeof __require&&__require,r=0;r<i.length;r++)n(i[r]);return n}({Box:[function(t,e,o){"use strict";cc._RF.push(e,"5e420jA5GpNkKYhK9JdObOh","Box"),cc.Class({extends:cc.Component,properties:{square:{default:null,type:cc.Node},column:{default:0,visible:!1},row:{default:0,visible:!1},fadeDuration:.75,delayDuration:.75},onLoad:function(){this.isMoved=!1,this.node.on("touchstart",function(t){this.touchBegin=t.touch.getLocation(),this.isMoved=!1},this),this.node.on("touchmove",function(t){if(!this.isMoved&&null!=this.square&&!this.square.getComponent("Square").moving){var e=t.touch.getLocation(),o=cc.v2(e.x-this.touchBegin.x,e.y-this.touchBegin.y),i=window.game;i.grid;if(Math.abs(o.x)>Math.abs(o.y)){if(Math.abs(o.x)>=i.sizeSquare.width/3){var n=null;null!=(n=o.x<0?i.getIndexLeftOf(this):i.getIndexRightOf(this))&&0==n.isNone()&&this.goTo(n.row,n.column)}}else if(Math.abs(o.y)>=i.sizeSquare.height/3){var s=null;s=o.y<0?i.getIndexDownOf(this):i.getIndexUpOf(this),console.log(s.row+" - "+s.column),null!=s&&0==s.isNone()&&this.goTo(s.row,s.column)}}},this),this.node.on("touchend",function(t){if(0==this.isMoved&&null!=this.square){var e=this.square.getComponent("Square");null==e&&void 0==e||e.moveToPosition(this.node.position)}this.isMoved=!1},this)},goTo:function(t,e){if(arguments.length>2&&void 0!==arguments[2]&&arguments[2])window.game.swap(this.row,this.column,t,e);else{var o=window.game.listBoxes[t][e].getComponent("Box"),i=window.game.simulateNewPostion(this,o);if(console.log("simulator lenght : "+i.length),i.length>0)window.game.swap(this.row,this.column,t,e);else console.log("not match -> revert"),window.game.simulateNewPostion(o,this).length>0?window.game.swap(this.row,this.column,t,e):console.log("all not match ")}this.isMoved=!0},destroySquare:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(null!=this.square&&!this.square.getComponent("Square").died){if(t)this.square.getComponent("Square").died=!0,this.square.runAction(cc.removeSelf(!0)),this.square=null;else{var e=cc.sequence(cc.fadeTo(this.fadeDuration,0),cc.delayTime(this.delayDuration),cc.removeSelf(!0),cc.callFunc(function(){this.square=null},this));e.setTag(-1),this.square.getComponent("Square").died=!0,this.square.runAction(e)}console.log("destroy")}}}),cc._RF.pop()},{}],Game:[function(t,e,o){"use strict";cc._RF.push(e,"d1b46wtcHNIvIu+XTBcbxCT","Game");n(t("./Square.js"));var i=n(t("./Box.js"));function n(t){return t&&t.__esModule?t:{default:t}}function s(t,e){this.row=t,this.column=e}function r(t,e,o){this.direction=e,this.box=t,this.score=o}s.prototype.isNone=function(){return-1==this.row||-1==this.column},r.prototype.handle=function(){if(this.box instanceof i.default){var t=new s(-1,-1);"left"==this.direction&&(t=window.game.getIndexLeftOf(this.box)),"right"==this.direction&&(t=window.game.getIndexRightOf(this.box)),"up"==this.direction&&(t=window.game.getIndexUpOf(this.box)),"down"==this.direction&&(t=window.game.getIndexDownOf(this.box)),this.box.goTo(t.row,t.column,!0)}},cc.Class({extends:cc.Component,properties:{width:10,height:10,delayTimeReset:2,aiControll:!1,square:{default:null,type:cc.Prefab},box:{default:null,type:cc.Prefab},sizeSquare:{default:new cc.Size},squareTypes:{default:[],type:cc.Color},button:{default:null,type:cc.Button},listBoxes:new Array,grid:new Array},onLoad:function(){this.isResetBoard=!1,this.hasUpdated=!1,this.delayTimeAction=0,this.button.node.on("click",function(t){this.aiControll=!this.aiControll},this),this.getGrid(),this.generateSquares(),window.game=this,this.checkMatchAll(),this.updatePositionSquare(),0==this.findAvaiableStep().length&&(console.log("reset"),this.isResetBoard=!0)},update:function(t){this.hasUpdated=!1,this.checkMatchAll();this.updatePositionSquare();if(this.updateNewSquare(),this.hasUpdated){var e=this.findAvaiableStep();this.isResetBoard||0!=e.length?e.length>0&&(this.aiControll&&0==this.delayTimeAction&&(this.aiControll=!1,this.node.runAction(cc.sequence(cc.delayTime(1),cc.callFunc(function(){var t=e[0];e.forEach(function(e){t.score<e.score&&(t=e)}),t.handle(),console.log("AI handle score : "+t.score),this.aiControll=!0},this)))),this.isResetBoard=!1):(console.log("reset"),this.isResetBoard=!0),this.isResetBoard&&this.resetBoard()}this.delayTimeAction-=t,this.delayTimeAction<0&&(this.delayTimeAction=0)},getGrid:function(){new cc.size(this.node.width,this.node.height);for(var t=cc.v2(0,0),e=t.x-this.sizeSquare.width*this.width/2+this.sizeSquare.width/2,o=e,i=t.y-this.sizeSquare.height*this.height/2+this.sizeSquare.height/2,n=0;n<this.height+1;n++){this.grid.push(new Array);for(var s=0;s<this.width;s++)this.grid[n].push(cc.v2(o,i)),o+=this.sizeSquare.width;o=e,i+=this.sizeSquare.height}},generateSquares:function(){for(var t=0;t<this.height;t++){this.listBoxes.push(new Array);for(var e=0;e<this.width;e++){var o=this.grid[t][e],i=this.getColorInArray(this.squareTypes),n=this.createBoxAt(t,e,o,i);this.listBoxes[t].push(n)}}},resetBoard:function(){for(var t=[],e=0;e<this.height;e++)for(var o=0;o<this.width;o++){var i=this.listBoxes[e][o].getComponent("Box");if(null==i.square)return;var n=i.square.getComponent("Square");if(n.moving||n.died)return;t.push(i)}console.log("reset"),this.node.runAction(cc.sequence(cc.delayTime(this.delayTimeReset),cc.callFunc(function(){this.isResetBoard&&(t.forEach(function(t){t.destroySquare(!0)}),this.isResetBoard=!1)},this)))},createBoxAt:function(t,e,o,i){var n=cc.instantiate(this.box),s=n.getComponent("Box");return s&&(s.row=t,s.column=e,this.createSquareAt(s,o,i)),n.setPosition(o),this.node.addChild(n,10),n},createSquareAt:function(t,e,o){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:cc.v2(-1,-1);t.square=cc.instantiate(this.square),t.square.color=o,t.square.setPosition(e),this.node.addChild(t.square,20),i.equals(cc.v2(-1,-1))||i.equals(e)||t.square.getComponent("Square").moveToPosition(i)},getColorInArray:function(t){return 0==t.length?cc.Color.WHITE:t[Math.floor(Math.random()*t.length)]},checkMatchAll:function(){for(var t=new Array,e=function(e,o,i){var n=i.length;return null==e.square||null==o.square||e.square.getComponent("Square").died||o.square.getComponent("Square").died?n<3?i.length>0&&i.splice(0,i.length):n>=3&&(t.push(i),i=new Array):e.square.color.equals(o.square.color)?(0==n&&i.push(e),i.push(o)):n<3?i.length>0&&i.splice(0,i.length):n>=3&&(t.push(i),i=new Array),i},o=0;o<this.height;o++){for(var n=new Array,s=1;s<this.width;s++){0,n=e(this.listBoxes[o][s-1].getComponent("Box"),this.listBoxes[o][s].getComponent("Box"),n)}n.length>=3&&s==this.width&&t.push(n),n=new Array}for(var r=0;r<this.width;r++){for(var h=new Array,a=1;a<this.height;a++){0,h=e(this.listBoxes[a-1][r].getComponent("Box"),this.listBoxes[a][r].getComponent("Box"),h)}h.length>=3&&a==this.height&&t.push(h),h=new Array}return t.forEach(function(t){t.forEach(function(t){t instanceof i.default&&t.destroySquare()})}),t.length>0},updatePositionSquare:function(){function t(t,e){this.box=t,this.count=e}for(var e=new Array,o=0;o<this.width;o++)for(var i=0,n=0;n<this.height;n++){var s=this.listBoxes[n][o].getComponent("Box");if(null==s.square&&n<this.height-1)++i;else if(0!=i){var r=new t(s,i);e.push(r)}}var h=!1;return e.forEach(function(t){if(null!=t.box){var e=t.box;e.row-t.count>=0&&((h||null==e.square)&&(h||null==this.listBoxes[e.row-t.count][e.column].getComponent("Box").square)||(this.delayTimeAction+=e.square.getComponent("Square").moveDuration,h=!0),this.swap(e.row,e.column,e.row-t.count,e.column))}},this),e>0},updateNewSquare:function(){for(var t=new Array,e=0;e<this.width;e++)for(var o=0;o<this.height;o++){var i=this.listBoxes[o][e].getComponent("Box");if(null==i.square)t.push(new s(i.row,i.column));else if(i.square.getComponent("Square").died)return}var n=!1;t.forEach(function(t){var e=this.listBoxes[t.row][t.column].getComponent("Box"),o=this.grid[this.height][t.column],i=this.getColorInArray(this.squareTypes);this.createSquareAt(e,o,i,e.node.position),n||(this.delayTimeAction+=e.square.getComponent("Square").moveDuration,n=!0)},this),this.hasUpdated=!0},simulateNewPostion:function(t,e){var o=[];if(void 0!==e&&void 0!==t&&null!=t.square){var i=t.square.color,n=[],s=e.column-1,r=e.column+1;for(t.column<e.column?s=-1:t.column>e.column&&(r=this.width);;){if(s>=0){var h=this.listBoxes[e.row][s].getComponent("Box");null!=h.square&&h.square.color.equals(i)?n.push(h):s=-1}if(r<this.width){var a=this.listBoxes[e.row][r].getComponent("Box");null!=a.square&&a.square.color.equals(i)?n.push(a):r=this.width}if(--s,++r,0==n.length)break;if(s<0&&r>=this.width){n.length>=2&&n.forEach(function(t){o.push(t)});break}}n=[];var u=e.row+1,l=e.row-1;for(t.row<e.row?l=-1:t.row>e.row&&(u=this.height);;){if(u<this.height){var c=this.listBoxes[u][e.column].getComponent("Box");null!=c.square&&c.square.color.equals(i)?n.push(c):u=this.height}if(l>=0){var d=this.listBoxes[l][e.column].getComponent("Box");null!=d.square&&d.square.color.equals(i)?n.push(d):l=-1}if(++u,--l,0==n.length)break;if(l<0&&u>=this.height){n.length>=2&&n.forEach(function(t){o.push(t)});break}}}return o},findAvaiableStep:function(){for(var t=[],e=0;e<this.height-1;e++)for(var o=0;o<this.width-1;o++){var i=this.listBoxes[e][o].getComponent("Box");if(o>0){var n=this.listBoxes[e][o-1].getComponent("Box");if(void 0!==n){var s=this.simulateNewPostion(i,n);s.length>0&&t.push(new r(i,"left",s.length))}}if(o<this.width-1){var h=this.listBoxes[e][o+1].getComponent("Box");if(void 0!==h){var a=this.simulateNewPostion(i,h);a.length>0&&t.push(new r(i,"right",a.length))}}if(e<this.height-1){var u=this.listBoxes[e+1][o].getComponent("Box");if(void 0!==u){var l=this.simulateNewPostion(i,u);l.length>0&&t.push(new r(i,"up",l.length))}}if(e>0){var c=this.listBoxes[e-1][o].getComponent("Box");if(void 0!==c){var d=this.simulateNewPostion(i,c);d.length>0&&t.push(new r(i,"down",d.length))}}}return t},swap:function(t,e,o,i){var n=this.listBoxes[t][e].getComponent("Box"),s=this.listBoxes[o][i].getComponent("Box"),r=n.node.position,h=s.node.position;if(null!=n.square){var a=n.square.getComponent("Square");null!=a&&a.moveToPosition(h)}if(null!=s.square){var u=s.square.getComponent("Square");null!=u&&u.moveToPosition(r)}var l=n.square;n.square=s.square,s.square=l},getIndexLeftOf:function(t){if(t instanceof i.default){var e=0==t.column?-1:t.column-1;return new s(t.row,e)}},getIndexRightOf:function(t){if(t instanceof i.default){var e=t.column==this.width-1?-1:t.column+1;return new s(t.row,e)}},getIndexUpOf:function(t){if(t instanceof i.default)return new s(t.row==this.height-1?-1:t.row+1,t.column)},getIndexDownOf:function(t){if(t instanceof i.default)return new s(0==t.row?-1:t.row-1,t.column)}}),cc._RF.pop()},{"./Box.js":"Box","./Square.js":"Square"}],Square:[function(t,e,o){"use strict";cc._RF.push(e,"fe29fBUvYZALo9QCr20UQ8w","Square"),cc.Class({extends:cc.Component,properties:{moveDuration:.25},onLoad:function(){this.died=!1,this.moving=!1},moveToPosition:function(t){if(this.died)return!1;this.node.stopActionByTag(1);var e=cc.sequence(cc.moveTo(this.moveDuration,t),cc.callFunc(function(){this.moving=!1},this));return e.setTag(1),this.moving=!0,this.node.runAction(e),!0}}),cc._RF.pop()},{}]},{},["Box","Game","Square"]);